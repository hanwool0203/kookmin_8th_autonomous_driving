<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/roslib@1.1.0/build/roslib.min.js"></script>
    <style>
        body { margin: 0; text-align: center; background-color: #f4f4f4; overflow: hidden; touch-action: none; }
        .container { display: flex; flex-direction: column; align-items: center; height: 100vh; }
        .video-container { width: 100%; max-width: 1000px; }
        .video-container img { width: 100%; height: auto; }
        .touch-container { flex-grow: 1; display: flex; width: 100%; height: 100%; position: relative; }
        .touch-area { flex: 1; height: 100%; }
        .left { background-color: rgba(0, 0, 255, 0.1); }
        .right { background-color: rgba(255, 0, 0, 0.2); }
    </style>
</head>
<body>
    <div class="container">
        <div class="video-container">
            <img id="video-stream" src="http://10.42.0.1:8080/stream?topic=/image_raw">
        </div>
        <div class="touch-container">
            <div class="touch-area left"></div>
            <div class="touch-area right"></div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // ‚úÖ WebSocket Ïó∞Í≤∞
            let ros = new ROSLIB.Ros({ url: "ws://10.42.0.1:9090" });

            ros.on("connection", function() { console.log("‚úÖ WebSocket Ïó∞Í≤∞ ÏÑ±Í≥µ"); });
            ros.on("error", function(error) { console.error("üö® WebSocket Ïò§Î•ò", error); });

            // ‚úÖ /xycar_motor ÌÜ†ÌîΩ ÏÉùÏÑ±
            let xycarMotor = new ROSLIB.Topic({
                ros: ros,
                name: "/xycar_motor",
                //messageType: "xycar_msgs/msg/XycarMotor"
                messageType: "std_msgs/msg/Float32MultiArray"
            });

            let speed = 0, angle = 0;
            let screenCenterX = window.innerWidth / 2;
            let screenHeight = window.innerHeight;
            
            document.addEventListener("touchmove", function(event) {
                event.preventDefault();
                let leftTouch = null, rightTouch = null;

                for (let touch of event.touches) {
                    if (touch.clientX < screenCenterX) {
                        let normY = 1 - (touch.clientY / screenHeight);
                        speed = (normY * 400) - 120;
                    } else {
                        let normX = ((touch.clientX - screenCenterX) / (screenCenterX)) * 2 - 1;
                        angle = (normX) * 120;
                    }
                }
                
                console.log(`üì± ÏÜçÎèÑ: ${speed.toFixed(2)}, Ï°∞Ìñ•: ${angle.toFixed(2)}`);
                let motorMsg = new ROSLIB.Message({
                    //header: { stamp: { sec: 0, nanosec: 0 }, frame_id: "" },
                    //angle: angle,
                    //speed: speed
                    data: [angle, speed] // <-- angleÍ≥º speedÎ•º Î∞∞Ïó¥Î°ú Î¨∂Ïñ¥ data ÌïÑÎìúÏóê Ìï†Îãπ
                });
                xycarMotor.publish(motorMsg);
            });

            document.addEventListener("touchend", function() {
                speed = 0;
                angle = 0;
                let motorMsg = new ROSLIB.Message({
                    //header: { stamp: { sec: 0, nanosec: 0 }, frame_id: "" },
                    //angle: 0.0,
                    //speed: 0.0
                    data: [0.0, 0.0] // <-- angle: 0.0  speed: 0.0
                });
                xycarMotor.publish(motorMsg);
                console.log("üõë ÌÑ∞Ïπò Ï¢ÖÎ£å - Ï∞®Îüâ Ï†ïÏßÄ");
            });
        });
    </script>
</body>
</html>

